# =============================================================================
# MISE TASK RUNNER CONFIGURATION
# =============================================================================
# Mise is a task runner that provides convenient shortcuts for common operations.
# Run 'mise tasks' to see all available tasks.
#
# Documentation: https://mise.jdx.dev/
# Install: curl https://mise.jdx.dev/install.sh | sh
# =============================================================================

[tools]
bun = "1.3.9"
rust = "1.93.0"

[env]
_.file = [".env"]
_.path = ["{{config_root}}/node_modules/.bin"]
CARGO_TERM_COLOR = "always"

[tasks]

# ── Build ────────────────────────────────────────────────────────────────────

[tasks.build]
description = "Build all workspace crates"
run = "cargo build --workspace"

[tasks."build:release"]
description = "Build all workspace crates in release mode"
run = "cargo build --workspace --release"

# ── Test ─────────────────────────────────────────────────────────────────────

[tasks.test]
description = "Run all workspace tests"
run = "cargo test --workspace"

[tasks."test:wire"]
description = "Run bcp-wire tests"
run = "cargo test -p bcp-wire"

[tasks."test:types"]
description = "Run bcp-types tests"
run = "cargo test -p bcp-types"

[tasks."test:encoder"]
description = "Run bcp-encoder tests"
run = "cargo test -p bcp-encoder"

[tasks."test:decoder"]
description = "Run bcp-decoder tests"
run = "cargo test -p bcp-decoder"

# ── Lint ─────────────────────────────────────────────────────────────────────

[tasks.clippy]
description = "Run clippy with pedantic lints on all crates"
run = "cargo clippy --workspace -- -W clippy::pedantic"

[tasks.fmt]
description = "Format all Rust source files"
run = "cargo fmt --all"

[tasks."fmt:check"]
description = "Check formatting without modifying files"
run = "cargo fmt --all -- --check"

# ── Check (fast compile check, no codegen) ───────────────────────────────────

[tasks.check]
description = "Type-check all workspace crates"
run = "cargo check --workspace"

# ── Docs ─────────────────────────────────────────────────────────────────────

[tasks.doc]
description = "Generate rustdoc for all workspace crates"
run = "cargo doc --workspace --no-deps"

[tasks."doc:open"]
description = "Generate and open rustdoc in browser"
run = "cargo doc --workspace --no-deps --open"

[tasks."doc:serve"]
description = "Serve the rustdoc documentation site on port 8080"
run = "bunx serve -p 8080 ./target/doc"

[tasks."docsite:serve"]
description = "Serve the docsify documentation site on port 4040"
run = "bunx serve -p 4040 ./docs"

# ── CI (composite) ──────────────────────────────────────────────────────────

[tasks.ci]
description = "Run the full CI pipeline: fmt check, clippy, test"
run = """
cargo fmt --all -- --check
cargo clippy --workspace -- -W clippy::pedantic
cargo test --workspace
"""

# ── Clean ────────────────────────────────────────────────────────────────────

[tasks.clean]
description = "Remove build artifacts"
run = "cargo clean"

# ── loclaude ────────────────────────────────────────────────────────────────────

# ── loclaude - Docker ────────────────────────────────────────────────────────────────────

[tasks."lc:docker:up"]
description = "Start Ollama and Open WebUI containers"
run = "loclaude docker-up"

[tasks."lc:docker:down"]
description = "Stop all containers"
run = "loclaude docker-down"

[tasks."lc:docker:restart"]
description = "Restart all containers"
run = "loclaude docker-restart"

[tasks."lc:docker:status"]
description = "Show container status"
run = "loclaude docker-status"

[tasks."lc:docker:logs"]
description = "Follow container logs"
run = "loclaude docker-logs --follow"

# ── loclaude - Model Management ────────────────────────────────────────────────────────────────────

[tasks."lc:models"]
description = "List installed models"
run = "loclaude models"

[tasks."lc:pull"]
description = "Pull a model (usage: mise run pull <model-name>)"
run = "loclaude models-pull {{arg(name='model')}}"

[tasks."lc:pull:recommended"]
description = "Pull the recommended coding model"
run = "loclaude models-pull qwen3-coder:30b"

# ── loclaude - Claude Code ────────────────────────────────────────────────────────────────────

[tasks."lc:claude"]
description = "Run Claude Code with local Ollama"
run = "loclaude run"

[tasks."lc:claude:model"]
description = "Run Claude with specific model (usage: mise run claude:model <model>)"
run = "loclaude run -m {{arg(name='model')}}"

# ── loclaude - Diagnostics ────────────────────────────────────────────────────────────────────

[tasks."lc:doctor"]
description = "Check system requirements"
run = "loclaude doctor"

[tasks."lc:gpu"]
description = "Check GPU status (requires NVIDIA GPU)"
run = "docker exec ollama nvidia-smi"

[tasks."lc:config"]
description = "Show current configuration"
run = "loclaude config"
